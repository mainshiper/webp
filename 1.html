<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>웹 커뮤니티</title>
  <!-- Bootstrap CSS -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', () => {
      const firebaseConfig = {
        apiKey: "AIzaSyA412fvUjgEcsFIDNoreoSjpl2kJwkUr7s",
        authDomain: "website-b8e72.firebaseapp.com",
        projectId: "website-b8e72",
        storageBucket: "website-b8e72.appspot.com",
        messagingSenderId: "36605001158",
        appId: "1:36605001158:web:46eeeae785ca41693346c7",
        measurementId: "G-NHP9CW0B2L",
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth();
      const db = getFirestore(app);

      // 회원가입 및 로그인 기능
      const signUpButton = document.getElementById("SignUpButton2");
      const loginButton = document.getElementById("LoginButton2");
      const googleLoginButton = document.getElementById("GoogleLoginButton");
      const logoutButton = document.getElementById("logout-button");
      const writeForm = document.getElementById("write-form");

      if (signUpButton) {
        signUpButton.addEventListener("click", async (event) => {
          event.preventDefault();
          const SignUpEmail = document.getElementById("SignUpEmail").value;
          const SignUpPassword = document.getElementById("SignUpPassword").value;
          const SignUpNickname = document.getElementById("SignUpNickname").value;

          try {
            const userCredential = await createUserWithEmailAndPassword(auth, SignUpEmail, SignUpPassword);
            const user = userCredential.user;
            await updateProfile(user, { displayName: SignUpNickname });
            console.log("회원가입 및 닉네임 설정 성공");
            alert("회원가입 및 닉네임 설정 성공");
          } catch (error) {
            console.error("회원가입 실패", error);
            alert("회원가입 실패");
          }
        });
      }

      if (loginButton) {
        loginButton.addEventListener("click", async (event) => {
          event.preventDefault();
          const LoginEmail = document.getElementById("LoginEmail").value;
          const LoginPassword = document.getElementById("LoginPassword").value;

          try {
            const userCredential = await signInWithEmailAndPassword(auth, LoginEmail, LoginPassword);
            const user = userCredential.user;
            document.getElementById("login-card").style.display = "none";
            document.getElementById("welcome-card").style.display = "block";
            document.getElementById("welcome-message").textContent = `${user.displayName || user.email}님 환영합니다.`;
          } catch (error) {
            console.error("로그인 실패", error);
            alert("로그인 실패");
          }
        });
      }

      if (googleLoginButton) {
        googleLoginButton.addEventListener("click", async (event) => {
          event.preventDefault();
          const provider = new GoogleAuthProvider();

          try {
            const result = await signInWithPopup(auth, provider);
            const user = result.user;
            document.getElementById("login-card").style.display = "none";
            document.getElementById("welcome-card").style.display = "block";
            document.getElementById("welcome-message").textContent = `${user.displayName || user.email}님 환영합니다.`;
          } catch (error) {
            console.error("구글 로그인 실패", error);
            alert("구글 로그인 실패");
          }
        });
      }

      if (logoutButton) {
        logoutButton.addEventListener("click", async () => {
          try {
            await signOut(auth);
            document.getElementById("login-card").style.display = "block";
            document.getElementById("welcome-card").style.display = "none";
            alert("로그아웃 성공");
          } catch (error) {
            console.error("로그아웃 실패", error);
            alert("로그아웃 실패");
          }
        });
      }

      // 글 작성 기능
      if (writeForm) {
        writeForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          const title = document.getElementById("title").value;
          const content = document.getElementById("content").value;

          try {
            await addDoc(collection(db, "posts"), {
              category: "일반/자유", // 카테고리를 예시로 추가
              title: title,
              content: content,
              author: auth.currentUser.displayName || auth.currentUser.email,
              timestamp: Timestamp.now(),
              comments: 0, // 댓글 수를 기본값으로 0으로 설정
              views: 0 // 조회수를 기본값으로 0으로 설정
            });
            alert("게시글 작성 성공");
            $('#writeModal').modal('hide');
            loadPosts(); // 게시글 목록 갱신
          } catch (error) {
            console.error("게시글 작성 실패", error);
            alert("게시글 작성 실패");
          }
        });
      }

      // 게시글 목록 불러오기
      async function loadPosts() {
        const postList = document.getElementById("post-list");
        postList.innerHTML = "<tr><td colspan='5'>게시글을 불러오는 중...</td></tr>";

        try {
          const querySnapshot = await getDocs(collection(db, "posts"));
          postList.innerHTML = "";
          querySnapshot.forEach((doc) => {
            const post = doc.data();
            const createdAt = post.timestamp ? new Date(post.timestamp.seconds * 1000).toLocaleString() : "N/A";
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${post.category}</td>
              <td>${post.title}</td>
              <td>${post.author}</td>
              <td>${createdAt}</td>
              <td>${post.views}</td>
            `;
            tr.addEventListener("click", async () => {
              try {
                await updateDoc(doc(db, "posts", doc.id), {
                  views: post.views + 1
                });
                loadPosts(); // 조회수 증가 후 목록 갱신
              } catch (error) {
                console.error("조회수 업데이트 실패", error);
              }
            });
            postList.appendChild(tr);
          });
        } catch (error) {
          console.error("게시글 불러오기 실패", error);
          postList.innerHTML = "<tr><td colspan='5'>게시글 불러오기 실패</td></tr>";
        }
      }

      // 초기화 시 게시글 목록 불러오기
      loadPosts();
    });
  </script>
</head>

<body>
  <header class="bg-dark text-white text-center py-3">
    <h1>웹 커뮤니티</h1>
  </header>
  <div class="container mt-4">
    <div class="row">
      <!-- 게시글 목록 -->
      <div class="col-md-9">
        <div class="text-center mb-4">
          <button type="button" class="btn btn-dark" data-toggle="modal" data-target="#writeModal">
            글 작성
          </button>
        </div>
        <table class="table">
          <thead>
            <tr>
              <th>카테고리</th>
              <th>제목</th>
              <th>글쓴이</th>
              <th>작성일</th>
              <th>조회수</th>
            </tr>
          </thead>
          <tbody id="post-list">
            <tr><td colspan="5">게시글을 불러오는 중...</td></tr>
          </tbody>
        </table>
      </div>
      <!-- 로그인 폼 -->
      <div class="col-md-3">
        <div class="card" id="login-card">
          <div class="card-body">
            <form id="login-form">
              <div class="form-group">
                <label for="email">이메일</label>
                <input type="email" class="form-control" id="LoginEmail" placeholder="이메일" required />
              </div>
              <div class="form-group">
                <label for="password">비밀번호</label>
                <input type="password" class="form-control" id="LoginPassword" placeholder="비밀번호" required />
              </div>
              <button type="button" class="btn btn-dark btn-block" id="LoginButton2">로그인</button>
              <button type="button" class="btn btn-dark btn-block" id="GoogleLoginButton">
                <img src="https://img.icons8.com/color/16/000000/google-logo.png" alt="Google Logo" /> 구글 로그인
              </button>
              <button type="button" class="btn btn-danger btn-block" data-toggle="modal" data-target="#signupModal">회원가입</button>
            </form>
          </div>
        </div>
        <div class="card" id="welcome-card" style="display: none;">
          <div class="card-body">
            <p id="welcome-message"></p>
            <button type="button" class="btn btn-dark btn-block" id="profile-button">프로필</button>
            <button type="button" class="btn btn-dark btn-block" id="logout-button">로그아웃</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- 글 작성 모달 -->
  <div class="modal fade" id="writeModal" tabindex="-1" role="dialog" aria-labelledby="writeModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="writeModalLabel">글 작성</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="write-form">
            <div class="form-group">
              <label for="title">제목</label>
              <input type="text" class="form-control" id="title" placeholder="제목" required />
            </div>
            <div class="form-group">
              <label for="content">내용</label>
              <textarea class="form-control" id="content" placeholder="내용" required></textarea>
            </div>
            <button type="submit" class="btn btn-dark btn-block">작성</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Bootstrap JS and dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
