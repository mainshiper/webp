<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>게시글 보기</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <style>
      .chat-button {
        display: inline-block;
        padding: 10px 20px;
        background-color: #333;
        color: white;
        text-align: center;
        border-radius: 5px;
        text-decoration: none;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <header class="bg-dark text-white text-center py-3">
      <h1>게시글 보기</h1>
    </header>
    <div class="container mt-4">
      <div class="card mb-4">
        <div class="card-body">
          <h5 id="postTitle"></h5>
          <div id="postContent"></div>
          <p><strong>카테고리:</strong> <span id="postCategory"></span></p>
          <p><strong>글쓴이:</strong> <span id="postAuthor"></span></p>
          <p><strong>작성일:</strong> <span id="postTimestamp"></span></p>
          <a href="chatting.html" class="chat-button" id="chatting-button"
            >채팅방 입장</a
          >
        </div>
      </div>
      <div class="card">
        <div class="card-body">
          <h5>댓글 작성</h5>
          <form id="comment-form">
            <div class="form-group">
              <label for="commentAuthor">작성자</label>
              <input
                type="text"
                class="form-control"
                id="commentAuthor"
                placeholder="작성자"
                readonly
              />
            </div>
            <div class="form-group">
              <label for="commentContent">내용</label>
              <textarea
                class="form-control"
                id="commentContent"
                rows="3"
                placeholder="내용"
              ></textarea>
            </div>
            <button type="button" class="btn btn-dark" id="submitComment">
              댓글 작성
            </button>
          </form>
          <hr />
          <h5>댓글 목록</h5>
          <ul class="list-group" id="commentList"></ul>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getFirestore,
        collection,
        doc,
        getDoc,
        addDoc,
        getDocs,
        query,
        where,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyA412fvUjgEcsFIDNoreoSjpl2kJwkUr7s",
        authDomain: "website-b8e72.firebaseapp.com",
        projectId: "website-b8e72",
        storageBucket: "website-b8e72.appspot.com",
        messagingSenderId: "36605001158",
        appId: "1:36605001158:web:46eeeae785ca41693346c7",
        measurementId: "G-NHP9CW0B2L",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // URL에서 게시글 ID 가져오기
      const urlParams = new URLSearchParams(window.location.search);
      const postId = urlParams.get("id");

      function timestampToDate(timestamp) {
        const seconds = timestamp.seconds;
        const nanoseconds = timestamp.nanoseconds;
        const milliseconds = seconds * 1000 + nanoseconds / 1000000;
        return new Date(milliseconds);
      }

      async function loadPost(postId) {
        const postDoc = doc(db, "posts", postId);
        try {
          const postSnap = await getDoc(postDoc);
          if (postSnap.exists()) {
            const post = postSnap.data();
            document.getElementById("postTitle").innerText = post.title;
            document.getElementById("postContent").innerHTML =
              post.content.replace(/<p><\/p>/g, "");
            document.getElementById("postCategory").innerText = post.category;
            document.getElementById("postAuthor").innerText = post.author;
            document.getElementById("postTimestamp").innerText =
              timestampToDate(post.timestamp).toLocaleDateString();

            // Store title in local storage
            document
              .getElementById("chatting-button")
              .addEventListener("click", () => {
                localStorage.setItem("chatTitle", post.title);
              });
          } else {
            console.log("No such document!");
            alert("게시글을 찾을 수 없습니다.");
          }
        } catch (error) {
          console.error("Error getting document:", error);
          alert("게시글을 불러오는데 실패했습니다.");
        }
      }

      async function loadComments(postId) {
        const commentList = document.getElementById("commentList");
        commentList.innerHTML =
          '<li class="list-group-item">댓글을 불러오는 중...</li>';
        try {
          const q = query(
            collection(db, "comments"),
            where("postId", "==", postId)
          );
          const querySnapshot = await getDocs(q);
          commentList.innerHTML = "";
          querySnapshot.forEach((doc) => {
            const comment = doc.data();
            const li = document.createElement("li");
            li.className = "list-group-item";
            li.innerHTML = `<strong>${comment.author}</strong>: ${comment.content}`;
            commentList.appendChild(li);
          });
        } catch (error) {
          console.error("Error loading comments: ", error);
          commentList.innerHTML =
            '<li class="list-group-item">댓글을 불러오는데 실패했습니다.</li>';
        }
      }

      async function submitComment() {
        const author = document.getElementById("commentAuthor").value;
        const content = document.getElementById("commentContent").value;
        if (author && content) {
          try {
            await addDoc(collection(db, "comments"), {
              postId: postId,
              author: author,
              content: content,
              timestamp: new Date(),
            });
            alert("댓글이 작성되었습니다.");
            document.getElementById("comment-form").reset();
            loadComments(postId);
          } catch (error) {
            console.error("Error writing comment: ", error);
            alert("댓글 작성에 실패했습니다.");
          }
        } else {
          alert("작성자와 내용을 모두 입력해주세요.");
        }
      }

      // 페이지 로드 시 게시글과 댓글 불러오기
      loadPost(postId);
      loadComments(postId);

      // 댓글 작성 시 작성자 필드 자동 채우기
      const nickname = localStorage.getItem("nickname");
      document.getElementById("commentAuthor").value = nickname;

      document
        .getElementById("submitComment")
        .addEventListener("click", submitComment);
    </script>
  </body>
</html>
